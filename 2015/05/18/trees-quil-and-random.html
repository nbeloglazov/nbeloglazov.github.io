<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Trees, Quil and Random</title>
    <meta name="viewport" content="width=device-width">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- Responsive CSS -->
    <link rel="stylesheet" href="/css/responsive.css">

    <!-- Google Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Raleway:300,400,700' rel='stylesheet' type='text/css'>

    <!-- Link to RSS feed -->
    
      <link rel="home" type="application/atom+xml" href="/feed.xml">
    

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-51485241-1', 'nbeloglazov.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js" async="true"></script>
  </head>
  <body>
    <div class="site">
      <aside class="sidebar" id="sidebar">
        <div class="header">
          
            <h1 class="title"><a href="/"><img id="avatar" src="/images/avatar.jpg"></a></h1>
            <span class="tagline">
              Quil, Сlojure and programming in general
            </span>
          
        </div>
        <div class="posts">
          <ul class="posts-list">
            
              <li class="post-link">
                <a class="post-title" href="/2015/06/15/live-reloading-in-quil-cljs.html">
                  <span class="post-date">15 Jun 2015</span>
                  Live Reloading in Quil Cljs
                </a>
              </li>
            
              <li class="post-link">
                <a class="post-title" href="/2015/05/18/trees-quil-and-random.html">
                  <span class="post-date">18 May 2015</span>
                  Trees, Quil and Random
                </a>
              </li>
            
              <li class="post-link">
                <a class="post-title" href="/2014/12/15/backup-mongodb-using-clojure.html">
                  <span class="post-date">15 Dec 2014</span>
                  Mongo Backup Using Clojure
                </a>
              </li>
            
              <li class="post-link">
                <a class="post-title" href="/2014/11/24/github-actions-in-hatnik.html">
                  <span class="post-date">24 Nov 2014</span>
                  GitHub Actions in Hatnik
                </a>
              </li>
            
          </ul>
       </div>
       <p class="all-posts-link">
         
         <a href="/all.html">All posts</a>
         
        </p>
        <div class="footer">
          <span id="footer-links">
            <a href="https://github.com/nbeloglazov" class="footer-link">GitHub</a>
            <span class="separator">&bull;</span>
            <a href="https://www.linkedin.com/in/nikitabeloglazov/" class="footer-link">LinkedIn</a>
            <span class="separator">&bull;</span>
            <a href="https://twitter.com/BeloglazovN/" class="footer-link">Twitter</a>
            <span class="separator">&bull;</span>
            
            <a href="/feed.xml">
            
              <img class="rss" src="/images/rss.png"/>
            </a>
          </span>
        </div>
      </aside>
        <article class="content" id="home">
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=258381704207913&version=v2.0";
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
  </script>
  <div id="sidebar-button">
    <img src="/images/sidebar-button.png">
  </div>
  <div id="post-info">
    <div id="info-container">
      
      <h1 id="title">Trees, Quil and Random</h1>
      <time datetime="2015-05-18" id="date" pubdate>18 May 2015</time>
    </div>
  </div>

  <div class="post">
    <p><img src="/images/trees/tree-0694.png" style="display: block; margin: auto;" alt="First tree"/></p>

<p>Last week I&#39;ve been playing with random tree generation in Quil. Idea is simple: generate a tree that resembles a real tree and doesn&#39;t make you think that it was generated by computer. Suprisingly it&#39;s not that hard to do. Tree is represented as a collection of branches. A branch consists of 3 components: start point, angle (from 0 to 2π) and length. Each branch can have 0, 1 or 2 sub-branches. Algorithm for generating sub-branches from a branch:</p>

<ol>
<li>Each branch can have up to 2 sub-branches. Probability of each sub-branch is 90%.</li>
<li>For each sub-ranch start point is calculated as end point of parent branch.</li>
<li>Sub-branch lengths are randomly selected from [0.7L, 1.0L], where L is parent&#39;s length.</li>
<li>Sub-branch angles are randomly selected from [α-¼π, α+¼π], where α is parent&#39;s angle.</li>
<li>Add sub-branches to the tree.</li>
</ol>

<p>Now, having the function for generating sub-branches, tree generation is easy:</p>

<ol>
<li>Create root: the first branch with angle ½π.</li>
<li>Branch-off each branch on previous level.</li>
<li>Repeat step 2 as many times as needed. My trees have 14 levels.</li>
<li>Concat all levels into single collection and draw them.</li>
</ol>

<p>Last part is especially easy to do in clojure and each step corresponds to one line:</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">generate-tree</span> <span class="p">[</span><span class="nb">root </span><span class="nv">levels</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="p">[</span><span class="nv">root</span><span class="p">]</span>
       <span class="p">(</span><span class="nb">iterate </span><span class="o">#</span><span class="p">(</span><span class="nb">mapcat </span><span class="nv">branch-off</span> <span class="nv">%</span><span class="p">))</span>
       <span class="p">(</span><span class="nb">take </span><span class="nv">levels</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">apply </span><span class="nv">concat</span><span class="p">)))</span>
</code></pre></div>
<p>That&#39;s it. Now more trees!</p>

<div style="display: flex; flex-wrap: wrap; justify-content: space-around;">
  <img src="/images/trees/tree-3649.png" style="margin: 5px 0px;" alt="Tree"/>
  <img src="/images/trees/tree-5551.png" style="margin: 5px 0px;" alt="Tree"/>
  <img src="/images/trees/tree-6173.png" style="margin: 5px 0px;" alt="Tree"/>
  <img src="/images/trees/tree-16160.png" style="margin: 5px 0px;" alt="Tree"/>
</div>

<p>White trees on black background look especially cool:</p>

<div style="display: flex; flex-wrap: wrap; justify-content: space-around;">
  <img src="/images/trees/tree-0890.png" style="margin: 5px 0px;" alt="Tree"/>
  <img src="/images/trees/tree-4042.png" style="margin: 5px 0px;" alt="Tree"/>
  <img src="/images/trees/tree-4509.png" style="margin: 5px 0px;" alt="Tree"/>
  <img src="/images/trees/tree-5177.png" style="margin: 5px 0px;" alt="Tree"/>
</div>

<h3>Quil tips</h3>

<p>I&#39;ve shown only static images of trees, but in reality they&#39;re animated so you can see how tree grows from a single root to a full tree with thousands of branches.</p>

<p>Initially I used a simple approach and was redrawing all branches on each frame. It works well when you have small number of branches but tree with 14 levels has 7000-10000 branches and drawing 10000 elements on each frame is well... slow. FPS drops from 60 to 10. So I optimized it a little, removed clearing background and changed <code>draw-branch</code> function to skip branches that are already fully drawn. That helped drastically bringing FPS back to 60. The big drawback that you can&#39;t do nice transformations now that may require redrawing everything. For example after tree is drawn I wanted to zoom into smallest branch and start drawing new tree from that branch, but it requires redrawing everything during zoom and I gave up this idea.</p>

<p>Another trick I did is around fading background color into tree color (see animations below). The idea is that screen background gradually turns to the same color as tree essentially clearing the tree. To achieve this the tree is drawn on a separate <a href="http://quil.info/api/image/rendering#create-graphics">graphics</a> object. Graphics object is transparent and when you copy it to main screen you can see background. With this technique <code>draw</code> function looks like the following:</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">draw</span> <span class="p">[</span><span class="nv">state</span><span class="p">]</span>
  <span class="c1">; Clear screen using calculated background screen. Background depends</span>
  <span class="c1">; on tree state: if tree is fully drawn it gradually changes to match the</span>
  <span class="c1">; tree color.</span>
  <span class="p">(</span><span class="nf">q/background</span> <span class="p">(</span><span class="nf">calculate-background-color</span> <span class="nv">state</span><span class="p">))</span>

  <span class="c1">; Draw active branches on graphics object. Note that we don&#39;t erase</span>
  <span class="c1">; existing branches, draw-tree only draws active branches. </span>
  <span class="p">(</span><span class="nf">q/with-graphics</span> <span class="p">(</span><span class="ss">:buffer</span> <span class="nv">state</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">draw-tree</span> <span class="nv">state</span><span class="p">))</span>

  <span class="c1">; Copy buffer graphics to main screen.</span>
  <span class="p">(</span><span class="nf">q/image</span> <span class="p">(</span><span class="ss">:buffer</span> <span class="nv">state</span><span class="p">)</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>And finally endless trees:</p>

<script src="/scripts/trees.js"></script>

<p><canvas id="tree"/></p>

<script>
  (function() {
    var width = document.querySelector(".post").offsetWidth;
    var height = 0.7 * width;
    trees.start_tree("tree", [width, height]);
  })();
</script>

<p>Controls (tree must have focus):</p>

<ul>
<li>r - regenerate tree;</li>
<li>up/down - change number of levels;</li>
<li>i - toggle stats;</li>
<li>s - save as image (opens in new tab);</li>
</ul>

<p>You can find source code on <a href="https://github.com/nbeloglazov/blog-projects/tree/master/trees">GitHub</a> or try it online on <a href="http://quil.info/sketches/show/example_tree">quil.info</a>.</p>

  </div>
  <div class="colophon">
    <p>
      <span id="pub-date">
        
          Published on
        
        18 May 2015
      </span>
    </p>
  </div>
  <div id="social-buttons">
    <g:plusone href="http://nbeloglazov.com/2015/05/18/trees-quil-and-random.html"></g:plusone>
    <a href="https://twitter.com/share" class="twitter-share-button" data-text="http://nbeloglazov.com/2015/05/18/trees-quil-and-random.html">Tweet</a>
    <script>
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
    </script>
    <div class="fb-like" data-href="http://nbeloglazov.com/2015/05/18/trees-quil-and-random.html" data-layout="button_count"
         data-action="like" data-show-faces="true" data-share="false"></div>
  </div>
  <!-- AddThis Button END -->
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'nbeloglazovblog';
    var disqus_identifier = '/2015/05/18/trees-quil-and-random';
    var disqus_title = 'Trees, Quil and Random';
    var disqus_url = 'http://nbeloglazov.com/2015/05/18/trees-quil-and-random.html';

    (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>


    </div>
    <script src="/scripts/responsive.js" type="text/javascript"></script>
  </body>
</html>
